---
title: "Assessing growth dynamics and connectivity of blacklip abalone (Haliotis rubra) populations in NW Tasmania"
subtitle: "AOTF Progress Report: Size-at-maturity (SAM)"
author:
  - name: Jaime McAllister
    affiliations:
        - name: IMAS, University of Tasmania
          department: IMAS-FA
date: last-modified
date-format: "[Last Updated on] DD MMMM, YYYY"
format:
  docx:
    highlight-style: github
    papersize: A4
    code-overflow: "wrap"
    reference-doc: word-styles-reference-01.docx
    toc: true
    number-sections: false
    toc-depth: 4
    number-depth: 4
    margin-left: 0.75in
    margin-right: 0.75in
    margin-top: 1in
    margin-bottom: 1in
  pdf:
    documentclass: scrreprt
    keep-tex:  true
    dpi: 600
    latex-auto-mk: true
    latex-auto-install: true
    # pdf-engine: pdflatex
    mainfont: Arial
    latex-tinytex: false
    toc: false
    toc-depth: 4
    toc_float: true
    number-sections: true
    number-depth: 4
    highlight-style: github
    papersize: "A4paper"
    #linestretch: 1.25
    fig_caption: yes
    geometry:
      - left = 20mm
      - right = 20mm
      - top = 20mm
      - bottom = 10mm
    header-includes:
      - \usepackage{float}
      - \floatplacement{table}{H}
    include-in-header: |
      \usepackage{amsmath}
      \usepackage{fontspec}
      \setmainfont{Arial}
      \usepackage{fancyhdr}
      \pagestyle{fancy}
      \fancyhf{} % clear header and footer
      \cfoot{\thepage} % center footer page number
      \renewcommand{\headrulewidth}{0pt}
      \renewcommand{\footrulewidth}{0pt}
      \AtBeginDocument{\thispagestyle{fancy}} % force page number on title page
      \renewcommand{\maketitle}{%
        {\centering
          \normalfont\Huge\bfseries\textsf{\title}\par\vskip 1.5em
          \LARGE\textsf{\subtitle}\par\vskip 1.2em
          \large\textsf{\author}\par\vskip 1em
          \textsf{\date}\par}
      }


editor: 
  markdown: 
    wrap: 72
---

```{r setup}
#| echo: false
#| warning: false
#| message: false

##---------------------------------------------------------------------------##
# Clear console
rm(list = ls())

##---------------------------------------------------------------------------##
## 1. Load libraries ####
suppressPackageStartupMessages({
        library(dplyr)
        library(ggplot2)
        library(scales)
        library(tidyr)
        library(gdata)
        library(openxlsx)
        library(lubridate)
        library(reshape)
        library(gridExtra)
        library(ggpubr)
        library(readxl)
        library(tibble)
        library(data.table)
        library(janitor)
        library(anytime)
        library(stringr)
        library(broom)
        library(purrr)
        library(sf)
        library(ggspatial)
        library(tmap)
        library(sf)
        library(sp)
        library(RColorBrewer)
        library(viridis)
        library(ggpmisc)
        library(arsenal)
  library(fuzzyjoin)
 library(tidytext)
 library(ggrepel)
})

source("C:/GitCode/AbResearch/getLegend.r")
source("C:/GitCode/AbResearch/StandardError_Functions.r")

##---------------------------------------------------------------------------##
## 2. Set file paths ####

# Identify folder containing SAM data
data_folder <- file.path(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Projects/AIRF_2023_64/Data', 
                                            Sys.info()[["user"]]))

# Identify folder containing GIS data
gis_data_folder <- file.path(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Projects/AIRF_2023_64/GIS', 
                                            Sys.info()[["user"]]))

# Identify folder to save outputs 
output_folder <- file.path(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Projects/AIRF_2023_64/Data Analysis/SAM_Analysis', 
                                            Sys.info()[["user"]]))
##---------------------------------------------------------------------------##

```

```{r rawdata}
#| echo: false
#| warning: false
#| message: false

##---------------------------------------------------------------------------##
## 3. Load raw data ####

# Load SAM raw data
sam_dat <- read.xlsx(paste(data_folder, "/SAM_data/SAM_Database.xlsx", sep = ''), detectDates = T)

# Load site raw data
meta_dat <- read.xlsx(paste(data_folder, "/Field_MetaData/Field_MetaDatabase.xlsx", sep = ''), detectDates = T)

# Load gis data
gis_dat <- read.csv(paste(gis_data_folder, "/IMAS_NW_AbaloneSAM_ProposedSites_2024-01-23.csv", sep = ''))

```

```{r formatdata}
#| echo: false
#| warning: false
#| message: false

##---------------------------------------------------------------------------##
## 4. Re-format data ####

# Re-format Excel times for SAM data
sam_dat$process_start <- convertToDateTime(sam_dat$process_start, origin = "1970-01-01", tz = "Australia/HOBART")
sam_dat$process_finish <- convertToDateTime(sam_dat$process_finish, origin = "1970-01-01", tz = "Australia/HOBART")

sam_dat <- sam_dat %>% 
        mutate(process_start = strftime(process_start, format="%H:%M:%S"),
               process_finish = strftime(process_finish, format="%H:%M:%S"))

sam_dat$process_start_date_time <- as.POSIXct(paste(sam_dat$process_date, sam_dat$process_start), format = "%Y-%m-%d %H:%M:%S")
sam_dat$process_finish_date_time <- as.POSIXct(paste(sam_dat$process_date, sam_dat$process_finish), format = "%Y-%m-%d %H:%M:%S")


# Add size bin from sampling
sam_dat <- sam_dat %>% 
 mutate(size_bin = case_when(shell_length <= 59 ~ '0-60',
                             between(shell_length, 60, 79) ~ '60-80',
                             between(shell_length, 80, 99) ~ '80-100',
                             between(shell_length, 100, 119) ~ '100-120',
                             between(shell_length, 120, 139) ~ '120-140',
                             between(shell_length, 140, 159) ~ '140-160',
                             shell_length >= 160 ~ '160-180'))

```
# Overview

This milestone report provides an overview of progress to date in collecting new data to assess the reproductive condition of blacklip abalone in North West Tasmania, as part of the Abalone Industry Development Fund (AIDF) project Assessing Growth Dynamics and Connectivity of Blacklip Abalone (Haliotis rubra) Populations in NW Tasmania.

# Methods

## Abalone Collection and Handling Procedures

As of 14 November 2025, abalone have been collected from 12 sites within Block 5 (see @fig-map), with support from industry contractors who provided charter vessels and contributed local knowledge and logistical expertise.

At each site, 200 abalone were sampled by targeting between 20–40 individuals within each 20 mm size class increment from 60 mm to 140 mm. Collected abalone were placed in plastic fish bins, covered with hessian sacks, and kept moist and exposed to air until landing.

Upon landing, abalone were transferred to a refrigerated vehicle and transported to Tasmanian Seafoods. There, they were either held overnight in a refrigerated room (4 °C) or in live holding tanks prior to processing the following day.

During processing, abalone were removed from their shells and assessed for maturity status was determined following Jones et al. 2009:

* Stage 0, has no apparent development of gonad (immature).
* Stage 1, gonad development has started, such that it is possible to determine sex of animal, although the gonad at this stage is very slight, at its most developed form it is translucent so that the digestive gland is still visible underneath (immature).
* Stage 2, gonad is obvious at the extremities of the digestive gland, it is opaque but not yet fully formed. The eggs in females are visible at low magnification while males are viscous creamy yellow (mature).
* Stage 3, fully formed gonad (mature). Stages 1 to 3 can be grouped by sex but only stages 2 and 3 are considered mature as although in stage 1 sex may be determined, that individual is unlikely to be reproductive and so is categorised as immature male or female (mature).

```{r sam sites}
#| echo: false
#| warning: false
#| message: false
#| label: fig-map
#| fig-cap: "Map of size-at-maturity sites sampled in North West Tasmania (Block 5) as of 14 November 2025."

# Read in sub-block map
sf_subblock_map <- st_read(paste(sprintf("C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/GIS/SpatialLayers/IMAS_Layers/IMAS_subblock_rev2022.gpkg", Sys.info()[["user"]])), quiet = T)

# Read in Tas land map
tas_land <- st_read(paste(sprintf("C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/GIS/SpatialLayers/TasLand.gpkg", Sys.info()[["user"]])), quiet = T)

# Establish CRS
GDA2020 <- st_crs(7855)
GDA94 <- st_crs(28355)
WGS84 <- st_crs(4326)

# Transform sub-block map to GDA2020
sf_subblock_map <- st_transform(sf_subblock_map, GDA2020)

# Transform Tas land map to GDA2020
tas_land <- st_transform(tas_land, GDA2020)

# Join meta and gis data
site_dat <- left_join(meta_dat, gis_dat, by = c('site' = 'Site')) %>% 
 select(site, SiteNumber, xcoord, ycoord)

# Create sf of sites
site_dat_sf <- site_dat %>% 
 st_as_sf(coords = c("xcoord", "ycoord"), crs = WGS84) %>% 
 st_transform(., crs = GDA2020)

# create approx bbox to crop maps and zoom (use QGIS to manually get bbox coordinates)
bbox <- st_bbox(site_dat_sf)
bbox_poly <- st_as_sfc(bbox)
bbox_buffered <- st_buffer(bbox_poly, dist = 5000)
bbox_sf <- st_sf(geometry = bbox_buffered)

# crop subblock map and sites sampled to maximise zoom                           
site_sampled_crop <- st_crop(site_dat_sf, bbox_sf)
sf_subblock_map_crop <- st_crop(sf_subblock_map, bbox_sf)
sf_tas_land_crop <- st_crop(tas_land, bbox_sf)

# Create map
ggplot(data = st_geometry(sf_subblock_map_crop)) +
                geom_sf(fill = NA) +
 geom_sf(data = sf_tas_land_crop, fill = "#d9ead3")+
                geom_sf(data = site_sampled_crop)+
                scale_colour_manual(values = c('black'))+
 geom_text_repel(data = site_sampled_crop,
    aes(label = SiteNumber, geometry = geometry),
    stat = "sf_coordinates", # extracts coordinates from sf object
    size = 4,
    max.overlaps = Inf # ensures all labels are attempted
  )+
                theme_bw() +
                annotation_scale(location = "bl", width_hint = 0.5) +
                annotation_north_arrow(location = "br", which_north = "true", 
                                       pad_x = unit(0.05, "cm"), pad_y = unit(0.1, "cm"),
                                       style = north_arrow_fancy_orienteering)+
                theme(legend.position="none")+
 theme(axis.text.y = element_text(angle = 90, vjust = 0, hjust=0.5))+
                xlab('Longitude')+
                ylab('Latitude')

```


## Data analysis

Size at maturity (SAM) estimation and analysis has been performed using the 'biology' package in R developed by Malcom Haddon (Haddon 2025).

A dataframe has been created to run the 'fitmaturity' function where maturity has been classified as:

* I = stages 0-1
* M = stages 2-3.

# Results

## Data checks and summaries

Quick summary plots to look for outliers in length data. Summary counts for each of the target size classes from dive collections.

An initial examination of the raw data revealed no obvious outliers that warranted exclusion from further analysis.

```{r datachecks}
#| echo: false
#| warning: false
#| message: false

##---------------------------------------------------------------------------##
## 5. Data checks ####

# summary(sam_dat)


sam_dat %>% 
 filter(!is.na(shell_length)) %>% 
 ggplot()+
 geom_point(aes(x = shell_length, y = shell_width))+
 theme_bw()

sam_dat %>% 
 filter(!is.na(shell_length)) %>%
 ggplot()+
 geom_point(aes(x = shell_length, y = shell_height))+
 theme_bw()

sam_dat %>% 
 ggplot()+
 geom_point(aes(x = shell_width, y = shell_height))+
 theme_bw()

sam_dat %>% 
 filter(!is.na(shell_length)) %>%
 ggplot()+
 geom_histogram(aes(shell_length), binwidth = 20)+
 theme_bw()

sam_dat %>% 
 filter(!is.na(shell_length)) %>%
 mutate(size_bin = factor(size_bin, levels =c('0-60', '60-80', '80-100', '100-120', '120-140', '140-160', '160-180'))) %>% 
 ggplot()+
 geom_histogram(aes(size_bin), stat = 'count')+
 theme_bw()+
 theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.5),
       strip.text = element_text(size = 6))+
 facet_wrap(. ~ site, nrow = 3)

```

## Size-at-maturity by site

There was a broad range in size-at-maturity across the 12 sampled sites, ranging from 96.6 mm at Site 10 to 122.2 mm at Site 6 (Figures 3.1 to 3.3). This variation is consistent with our understanding of the spatial complexity and distinct population characteristics of abalone in this region of the fishery.

```{r maturity regression}
#| echo: false
#| warning: false
#| message: false
#| label: fig-prop-mature
#| fig-cap: "Proportion mature at length for blacklip abalone maturity data at each surveyed site in Block 5 (NW Tasmania) in 2025. Length at 50% maturity is indicated by the green vertical line, and sample size is presented in the top-left corner of the plot."

library(biology)
library(hplot)
library(codeutils)

# Convert lowercase to uppercase sex.
sam_dat <- sam_dat %>% 
 mutate(sex = toupper(sex))

# Classify gonad stage 1 abalone as immature.
sam_dat <- sam_dat %>% 
 mutate(sex_adj = case_when(gonad_score %in% c(0, 1) ~ 'I',
                            gonad_score >= 2 ~ sex),
        mature = case_when(gonad_score >= 2 ~ 1,
                           gonad_score <= 1 ~ 0))

# Create dataframe for fitmaturity function (site, sex, length, maturity)
tas_ab <- sam_dat %>%
 select(site, sex_adj, shell_length, mature) %>%
 dplyr::rename(sex = 'sex_adj',
               length = 'shell_length') %>%
 filter(sex != 'T') #filter any trematodes

# Re-classify sex as mature or immature
tas_ab <- tas_ab %>% 
 mutate(sex = case_when(sex %in% c('M', 'F') ~ 'M',
                        sex == 'I' ~ 'I'),
        site = str_replace(site, "AB-NW-SAM-2024-5-", "Site-"))

# Quick summary of samples by site and maturity status(sex)
# table(tas_ab$site, tas_ab$sex)

# Create parameters for loop and plots
sites <- sort(unique(tas_ab$site))
nsite <- length(sites)
# scenes <- c(
#  "AB-NW-SAM-2024-5-1",
#  "AB-NW-SAM-2024-5-2",
#  "AB-NW-SAM-2024-5-3",
#  "AB-NW-SAM-2024-5-4",
#  "AB-NW-SAM-2024-5-5",
#  "AB-NW-SAM-2024-5-6",
#  "AB-NW-SAM-2024-5-7",
#  "AB-NW-SAM-2024-5-8",
#  "AB-NW-SAM-2024-5-9",
#  "AB-NW-SAM-2024-5-10",
#  "AB-NW-SAM-2024-5-13",
#  "AB-NW-SAM-2024-5-17")
scenes <- c(
 "Site-1",
 "Site-2",
 "Site-3",
 "Site-4",
 "Site-5",
 "Site-6",
 "Site-7",
 "Site-8",
 "Site-9",
 "Site-10",
 "Site-13",
 "Site-17")
models <- makelist(scenes)
count <- 0

# Run model across each site for sexes combined
for (i in 1:nsite) { #  i = 1
    count <- count + 1
    picksite <- which(tas_ab$site == sites[i])
    models[[count]] <- fitmaturity(tas_ab[picksite,],
                                   length="length",mature="mature",lower=50,upper=160)
  }

# str1(models)
# str1(models[["Site1"]])

# Create maturity plots for each site
plotprep(width=15, height=15)
parset(plots=c(2,2))
for (i in 1:length(models)) {
  plotmaturity(models[[i]],label=scenes[i],col=2,xmin=0,xmax=0,CI=FALSE,
                           setpar=FALSE,lwd=2)  
}


```
## Size-at-maturity across Block 5

Preliminary analysis combining all sites sampled to data suggests that the overall size-at-maturity for Block 5 is approximately 109.3 mm (@fig-prop-mature-block).

```{r maturity regression block}
#| echo: false
#| warning: false
#| message: false
#| label: fig-prop-mature-block
#| fig-cap: "Proportion mature at length for blacklip abalone maturity data for Block 5 (NW Tasmania) in 2025. Length at 50% maturity is indicated by the green vertical line, and sample size is presented in the top-left corner of the plot."

# Run model across block for sexes combined
models <- fitmaturity(tas_ab, length = "length", mature = "mature", lower = 50,upper = 160)

# Create maturity plots for entire Block 5
plotprep(width=10, height=8)
# parset(plots=c(2,2))
plotmaturity(models, label = 'AB-NW-SAM-2024-Block-5', col = 2, xmax = 0, CI = F, setpar = F, lwd = 2)

```
# Shellology maturity status

The following analyses were conducted as part of the collaborative AIDF project, 'Assessing the Potential of SPR Methods to Improve Fishery Assessments and Management Decisions', sub-contracted to Dr Jeremy Prince.

## Internal shell scaring vs maturity
A quick summary plot comparing Prince 'shellology' classification of internal shell scaring and maturity status determined from macroscopic examination of gonads. A summary of the Shell_internal_score:

1. No scar formation.
2. Some pitting.
3. Quite pitted.
4. Secondary deposition forming.
5. Secondary deposition covers most of muscle attachment site.
6. Secondary deposition covers all of muscle attachment site.

```{r maturity scars}
#| echo: false
#| warning: false
#| message: false
#| label: fig-int-shell-count
#| fig-cap: "Total count of abalone for each internal shell classification from specimens sampled in Block 5 (NW Tasmania) in 2025."

# Convert lowercase to uppercase sex.
sam_dat <- sam_dat %>% 
 mutate(sex = toupper(sex))

# Classify gonad stage 1 abalone as immature.
sam_dat <- sam_dat %>% 
 mutate(sex_adj = case_when(gonad_score %in% c(0, 1) ~ 'I',
                            gonad_score >= 2 ~ sex),
        mature = case_when(gonad_score >= 2 ~ 1,
                           gonad_score <= 1 ~ 0))

mat_labs <- c('immature', 'mature')
names(mat_labs) <- c('0', '1')

sam_dat %>% 
 filter(!is.na(shell_internal) & sex != 'T') %>%
 ggplot()+
 geom_histogram(aes(factor(shell_internal)), stat = 'count')+
 theme_bw()+
 xlab('shell_internal_score')+
 facet_wrap(. ~ mature, labeller = labeller(mature = mat_labs))

```
Preliminary observations of internal shell condition suggest that scarring and secondary deposition become increasingly evident with maturation, supporting its potential use as an indicator of reproductive status (@fig-int-shell-count). However, it is important to note that this remains a destructive sampling method, requiring animals to be removed from their shells to assess internal shell features.

## External shell appearance vs maturity
A quick summary plot comparing Prince 'shellology' classification of external shell appearance and maturity status determined from external appearance and fouling of shell. A summary of the Shell_external_score:

1. Clean shell; no epiphytic growth.
2. Some epiphytic fouling but not advanced.
3. Hard fouling commenced around spire.
4. Fleshy fouling and coraline covering spire but ripple texture of shell apparent.
5. Fleshy fouling and coraline covering most of shell and ripple texture of shell non-apparent
6. Shell completely overgrown with hard fouling to growing edge.
7. Very thick fouling and shell completely overgrown.

```{r external score}
#| echo: false
#| warning: false
#| message: false
#| label: fig-ext-shell-count
#| fig-cap: "Total count of abalone for each external shell classification from specimens sampled in Block 5 (NW Tasmania) in 2025."

# Convert lowercase to uppercase sex.
sam_dat <- sam_dat %>% 
 mutate(sex = toupper(sex))

# Classify gonad stage 1 abalone as immature.
sam_dat <- sam_dat %>% 
 mutate(sex_adj = case_when(gonad_score %in% c(0, 1) ~ 'I',
                            gonad_score >= 2 ~ sex),
        mature = case_when(gonad_score >= 2 ~ 1,
                           gonad_score <= 1 ~ 0))

mat_labs <- c('immature', 'mature')
names(mat_labs) <- c('0', '1')

sam_dat %>% 
 filter(!is.na(shell_external) & !is.na(mature)) %>% 
 ggplot()+
 geom_histogram(aes(factor(shell_external)), stat = 'count')+
 theme_bw()+
 xlab('shell_external_score')+
 facet_wrap(. ~ mature, labeller = labeller(mature = mat_labs))

```
Preliminary observations align with our understanding of emergence patterns, with immature juvenile abalone typically exhibiting clean external shells and minimal coralline growth or other fouling (@fig-ext-shell-count). As animals mature, external fouling becomes increasingly apparent, supporting its potential use as a non-destructive macroscopic indicator of reproductive condition.

# Summary
Preliminary analysis of data from the 12 sampled sites revealed clear variation in size-at-maturity across the block, consistent with our initial understanding of abalone population dynamics in the region. The inclusion of additional shell classification metrics has provided a complementary means of validating reproductive condition, which will be further explored as the project progresses.

This work has now been incorporated into the broader AIRF 2023-64 project, which aims to examine abalone population dynamics across the region. The expanded scope includes additional size-at-maturity sampling, tagging and growth experiments, genetic and physiological assessments, and continued development of shell condition metrics to support SPR-based assessment approaches.

Estimates of legal minimum length, defined as size-at-maturity plus three years of post-maturity growth, have not yet been updated, pending further data from ongoing tagging studies. These updates will form part of the broader project, which is currently underway and scheduled for completion by late 2026.