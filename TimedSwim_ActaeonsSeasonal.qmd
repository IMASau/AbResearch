---
title: "Seasonal Actaeons Monitoring"
author: "Jaime McAllister"
format: pdf
editor: visual
date: last-modified
date-format: "[Last Updated on] DD MMMM, YYYY"
format:
  docx:
    highlight-style: github
    papersize: A4
    code-overflow: "wrap"
    reference-doc: word-styles-reference-01.docx
    toc: true
    number-sections: false
    toc-depth: 4
    number-depth: 4
    margin-left: 0.75in
    margin-right: 0.75in
    margin-top: 1in
    margin-bottom: 1in
    fig-format: png
    fig-dpi: 600
  pdf:
    documentclass: scrreport
    keep-tex:  true
    dpi: 600
    pdf-engine: lualatex
    toc: true
    toc-depth: 4
    toc_float: true
    number-sections: false
    number-depth: 4
    highlight-style: github
    papersize: "A4paper"
    linestretch: 1.25
    mainfont: Calibri
    geometry:
      - left = 20mm
      - right = 20mm
      - top = 20mm
      - bottom = 10mm
editor: 
  markdown: 
    wrap: 72
link-citations: true
---
\newpage

```{r setup}
#| echo: false
#| warning: false
#| message: false

##---------------------------------------------------------------------------##
# clear console
rm(list = ls())

## 1. Load libraries ####
suppressPackageStartupMessages({
 library(dplyr)
 library(ggplot2)
 library(ggrepel)
 library(scales)
 library(tidyr)
 library(fs)
 library(gdata)
 library(openxlsx)
 library(lubridate)
 library(reshape)
 library(gridExtra)
 library(ggpubr)
 library(readxl)
 library(tibble)
 library(data.table)
 library(stringr)
 library(broom)
 library(purrr)
 library(sf)
 library(ggspatial)
 library(tmap)
  library(sp)
 library(RColorBrewer)
 library(viridis)
 library(ggpmisc)
 library(lme4)
 library(pbkrtest)
 library(AICcmodavg)
 library(visreg)
 library(glmmTMB)
 library(DHARMa)
 library(emmeans)
 library(ggeffects)
 library(ggExtra)
 library(flextable)
 library(boot)
 library(coin)
})

set_flextable_defaults(#font.family = "Calibri (Body)",
                       font.size = 10,
                       # digits = 1,
                       # border.color = "#000000",
                       padding.bottom = 1,
                       padding.top = 1,
                       padding.left = 3,
                       padding.right = 1)

`%ni%` <- Negate(`%in%`)
is.ok <- Negate(is.na)

untibble <- function(tib) {
  data.frame(unclass(tib), stringsAsFactors = FALSE, check.names = FALSE)
} 

theme_set(theme_bw() + theme(plot.title = element_text(hjust = 0.5)))

  
# Identify sampling year of interest
samp_year <- 2025

# Identify input and output folders
infolder <- file.path(paste(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Abalone/FISdata', 
                                            Sys.info()[["user"]])), paste('FIS_TimedSwimSurveys', samp_year, sep = ''))

ts_plots_folder <- file.path(paste(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Abalone/Assessment/Figures/FIS', 
                                           Sys.info()[["user"]])), paste('FIS_TimedSwimSurveys', samp_year
                                                                         , '_Plots', sep = ''))


datetext <- now() |> format("%Y_%m_%d")

```
# Load Data

```{r loaddat}

# Load Actaeons blacklip data
# Note: this data includes all blacklip data standardised for fishyear.

myFile <- dir_info(infolder, recurse = FALSE, glob = "*.RData") %>%
  filter(type == "file",  size > "10KB") %>%
  arrange(desc(modification_time)) %>%
  filter(str_detect(path, "TimedSwimData_Stnd_202")) %>% 
  filter(modification_time == max(modification_time))

print(myFile$path)
load(myFile$path)
---

# Seasonal Actaeons monitoring post AIRF

Seasonal monitoring continues across 60 established sites in the Actaeons, building on baseline data collected during the AIRF project. Timed swim surveys are being conducted to track seasonal trends in abundance, with ongoing support provided through the SMRCA budget allocation.

```{r seasonal abundance}

##---------------------------------------------------------------------------##
# plot abundance by site for each sample period


# Summarise counts by site, sample period, and diver
ts_seasonal_dat_act <- ts_dat %>%
  mutate(ts_month = month(samp_date)) %>%
  filter(
    blockno == "13",
    between(ts_month, 1, 3)
  ) %>%
  mutate(sizeclass_act = case_when(
    sizeclass %in% c("0-60", "60-100", "0-100", "0-20", "20-40", "40-60", "60-80", "80-100", "100-120") ~ "0-120 mm",
    sizeclass %in% c("120-140") ~ "120-140 mm",
    TRUE ~ ">140 mm"
  ))

ts_working_dat_seasonal <- ts_seasonal_dat_act %>%  
 group_by(blockno, site, sampyear, diver_id, dive_dir, sizeclass_act) %>% 
 summarise(ab_n = sum(sizeclass_freq_10)) %>% 
 mutate(sampyear = as.factor(sampyear),
        site = as.factor(site),
        diver_id = as.factor(diver_id),
        sizeclass_act = as.factor(sizeclass_act)) %>%
 pivot_wider(
  names_from = sizeclass_act,
  values_from = ab_n
 ) %>% 
 dplyr::rename(sub_leg_n = "0-120 mm",
               sub_sub_n = "120-140 mm",
               leg_n = ">140 mm") %>% 
 mutate(total_n = sub_leg_n + sub_sub_n + leg_n,
        sub_leg_prop = sub_leg_n / total_n,
        sub_sub_prop = sub_sub_n / total_n,
        leg_prop = leg_n / total_n,
        study_loc = 'act_bl')


# determine number of sites per season
sites_n <- ts_working_dat_seasonal %>% 
 group_by(sampyear) %>% 
 summarise(sites = n_distinct(site))

# quick summary of mean proportion by year and size

mean_prop <- ts_working_dat_seasonal %>% 
 filter(site != 'AB-2023-13-166') %>% 
 group_by(sampyear) %>% 
 summarise(mean_sub_leg = mean(sub_leg_prop),
           mean_sub_sub = mean(sub_sub_prop),
           mean_leg = mean(leg_prop))


```


## Standardise seasonal data

```{r data standardisation}
#| echo: false
#| warning: false
#| message: false


# Containers
model_sub_leg <- list()
model_sub_sub <- list()
model_leg <- list()
predictions <- list()


# === Model A: Sublegal ===

sub_mod <- glmmTMB(
 sub_leg_n ~ sampyear +
  (1 | diver_id) + (1 | site) + (1 | site:sampyear),
 ziformula = ~ 1,
 data = ts_working_dat_seasonal,
 family = nbinom2
)

# Predict sublegal abundance
ts_working_dat_seasonal$sub_leg_pred <- predict(sub_mod, newdata = ts_working_dat_seasonal, type = "response")

# === Model B: Sub-sub Legal ===
ts_working_dat_seasonal <- ts_working_dat_seasonal %>%
 mutate(targprop = sub_sub_prop)

sub_sub_mod <- glmmTMB(
 sub_sub_n ~ sampyear +
  (1 | diver_id) + (1 | site) + (1 | site:sampyear),
 ziformula = ~ 1,
 data = ts_working_dat_seasonal,
 family = nbinom2
)

# Predict sub-sublegal abundance
ts_working_dat_seasonal$sub_sub_pred <- predict(sub_sub_mod, newdata = ts_working_dat_seasonal, type = "response")

# === Model C: Legal ===
legal_mod <- glmmTMB(
 leg_n ~ sampyear +
  (1 | diver_id) + (1 | site) + (1 | site:sampyear),
 ziformula = ~ 1,
 data = ts_working_dat_seasonal,
 family = nbinom2
)

# Predict legal abundance
ts_working_dat_seasonal$leg_pred <- predict(legal_mod, newdata = ts_working_dat_seasonal, type = "response")

```

## Plot obsevred vs standardised

```{r plot}



  summary_df <- ts_working_dat_seasonal %>%
    group_by(sampyear) %>%
    summarise(
      mean_sub_leg_obs = mean(sub_leg_n, na.rm = TRUE),
      se_sub_leg_obs = sd(sub_leg_n, na.rm = TRUE) / sqrt(n()),
      mean_sub_leg_pred = mean(sub_leg_pred, na.rm = TRUE),
      se_sub_leg_pred = sd(sub_leg_pred, na.rm = TRUE) / sqrt(n()),
      mean_sub_sub_obs = mean(sub_sub_n, na.rm = TRUE),
      se_sub_sub_obs = sd(sub_sub_n, na.rm = TRUE) / sqrt(n()),
      mean_sub_sub_pred = mean(sub_sub_pred, na.rm = TRUE),
      se_sub_sub_pred = sd(sub_sub_pred, na.rm = TRUE) / sqrt(n()),
      mean_leg_obs = mean(leg_n, na.rm = TRUE),
      se_leg_obs = sd(leg_n, na.rm = TRUE) / sqrt(n()),
      mean_leg_pred = mean(leg_pred, na.rm = TRUE),
      se_leg_pred = sd(leg_pred, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )

  # Transform and tag block
  plot_df <- summary_df %>%
    select(sampyear,
           mean_sub_leg_obs, se_sub_leg_obs,
           mean_sub_leg_pred, se_sub_leg_pred,
           mean_sub_sub_obs, se_sub_sub_obs,
           mean_sub_sub_pred, se_sub_sub_pred,
           mean_leg_obs, se_leg_obs,
           mean_leg_pred, se_leg_pred) %>%
    pivot_longer(
      cols = -sampyear,
      names_to = c("stat", "type"),
      names_pattern = "(mean|se)_(.*)"
    ) %>%
    pivot_wider(names_from = stat, values_from = value) %>%
    mutate(
      lower = mean - 1.96 * se,
      upper = mean + 1.96 * se,
      group = case_when(
        str_detect(type, "sub_leg") ~ "Sublegal",
        str_detect(type, "sub_sub") ~ "Sub-sub legal",
        str_detect(type, "leg") ~ "Legal"
      ),
      source = case_when(
        str_detect(type, "obs") ~ "Observed",
        str_detect(type, "pred") ~ "Predicted"
      ))


# Create jitter for points, lines and errorbars
combined_df <- plot_df %>%
  mutate(
    sampyear_num = as.numeric(as.character(sampyear)),
    jitter_offset = case_when(
      group == "Legal" ~ -0.1,
      group == "Sub-legal" ~ 0.1,
      group == "Sub-sub legal" ~ 0.1,
      TRUE ~ 0
    ),
    sampyear_jittered = sampyear_num + jitter_offset
  )

```

```{r facet plot error ribbon}

p <- ggplot(combined_df, aes(x = sampyear, y = mean, group = type)) +
  theme_bw(base_size = 14) +
  geom_line(aes(colour = source, linetype = group), linewidth = 1.2) +
  geom_point(aes(colour = source, shape = group), size = 2.5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = source), alpha = 0.2)+
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  # scale_y_continuous(limits = c(0, 80)) +
  labs(
    # title = "Observed vs Predicted Legal & Sublegal Counts by Block",
    x = "Year", y = "Mean count [abalone.10min-1]",
    colour = "Source", fill = "Source", linetype = "Size", shape = "Size"
  ) 

print(p)

```
## Standardised plot 

```{r predicted plot}

# Filter predicted data
predicted_df <- combined_df %>% filter(source == "Predicted")

predicted_df$group <- factor(predicted_df$group, levels = c("Legal", "Sub-sub legal", "Sublegal"))

# Define custom colors for legal and sub-legal
color_map <- c("Legal" = "blue", "Sub-sub legal" = "forestgreen", "Sublegal" = "red")

p <- ggplot(predicted_df, aes(x = sampyear_jittered, y = mean)) +
  theme_bw(base_size = 12) +

  geom_line(
    aes(colour = group, group = group),
    linewidth = 0.8
  ) +

  geom_point(
    aes(colour = group, group = group),
    size = 2.5
  ) +

  geom_errorbar(
    aes(
      x = sampyear_jittered,
      ymin = lower,
      ymax = upper,
      colour = group,
      group = group
    ),
    width = 0.3,
    linewidth = 0.8
  ) +
  scale_colour_manual(values = color_map) +
  # scale_fill_manual(values = color_map) +
  scale_y_continuous(limits = c(0, 35)) +
  labs(
    x = "Year",
    y = expression("Mean count [abalone.10min"^-1*"]"),
    colour = "Size", fill = "Size",
    linetype = "Size", shape = "Size"
  ) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

print(p)


ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_Actaeons', '.pdf', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)

```