---
title: "Fishery-Independent Monitoring of the Tasmanian East Coast Commercial Abalone Fishery Closure"
subtitle: "Timed Swim Surveys (2020–2025)"
author:
  - name: Jaime McAllister
    affiliations:
        - name: IMAS, University of Tasmania
          department: IMAS-FA
date: last-modified
date-format: "[Last Updated on] DD MMMM, YYYY"
format:
  docx:
    highlight-style: github
    papersize: A4
    code-overflow: "wrap"
    reference-doc: word-styles-reference-01.docx
    toc: true
    number-sections: false
    toc-depth: 4
    number-depth: 4
    margin-left: 0.75in
    margin-right: 0.75in
    margin-top: 1in
    margin-bottom: 1in
    fig-format: png
    fig-dpi: 600
  pdf:
    documentclass: scrreport
    keep-tex:  true
    dpi: 600
    pdf-engine: lualatex
    toc: true
    toc-depth: 4
    toc_float: true
    number-sections: false
    number-depth: 4
    highlight-style: github
    papersize: "A4paper"
    linestretch: 1.25
    mainfont: Calibri
    geometry:
      - left = 20mm
      - right = 20mm
      - top = 20mm
      - bottom = 10mm
editor: 
  markdown: 
    wrap: 72
link-citations: true
---
\newpage


```{r setup}
#| echo: false
#| warning: false
#| message: false

##---------------------------------------------------------------------------##
# clear console
rm(list = ls())

## 1. Load libraries ####
suppressPackageStartupMessages({
 library(dplyr)
 library(ggplot2)
 library(ggrepel)
 library(scales)
 library(tidyr)
 library(fs)
 library(gdata)
 library(openxlsx)
 library(lubridate)
 library(reshape)
 library(gridExtra)
 library(ggpubr)
 library(readxl)
 library(tibble)
 library(data.table)
 library(stringr)
 library(broom)
 library(purrr)
 library(sf)
 library(ggspatial)
 library(tmap)
  library(sp)
 library(RColorBrewer)
 library(viridis)
 library(ggpmisc)
 library(lme4)
 library(pbkrtest)
 library(AICcmodavg)
 library(visreg)
 library(glmmTMB)
 library(DHARMa)
 library(emmeans)
 library(ggeffects)
 library(ggExtra)
 library(flextable)
 library(XML)
})

set_flextable_defaults(#font.family = "Calibri (Body)",
                       font.size = 10,
                       # digits = 1,
                       # border.color = "#000000",
                       padding.bottom = 1,
                       padding.top = 1,
                       padding.left = 3,
                       padding.right = 1)

`%ni%` <- Negate(`%in%`)
is.ok <- Negate(is.na)

untibble <- function(tib) {
  data.frame(unclass(tib), stringsAsFactors = FALSE, check.names = FALSE)
} 

theme_set(theme_bw() + theme(plot.title = element_text(hjust = 0.5)))

  
# Identify sampling year of interest
samp_year <- 2025

# Identify input and output folders
infolder <- file.path(paste(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Abalone/FISdata', 
                                            Sys.info()[["user"]])), paste('FIS_TimedSwimSurveys', samp_year, sep = ''))




datetext <- now() |> format("%Y_%m_%d")

```
# Load Data

```{r loaddat}

myFile <- dir_info(infolder, recurse = FALSE, glob = "*.RData") %>%
  filter(type == "file",  size > "10KB") %>%
  arrange(desc(modification_time)) %>%
  filter(str_detect(path, "TimedSwimData_Stnd_202")) %>% 
  filter(modification_time == max(modification_time))

print(myFile$path)
load(myFile$path)

ts_plots_folder <- file.path(paste(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/Abalone/Assessment/Figures/FIS', 
                                           Sys.info()[["user"]])), paste('FIS_TimedSwimSurveys', samp_year, '_Plots/EastCoast_TS_Plots_', samp_year, sep = ''))

```
# Plotting

## Standardised vs observed

The following plot compares the standardised sub-legal and legal counts for each block using the chosen model as detailed in @ref(data-standardisation).

In summary,across both legal and sub-legal size classes:
- Predicted values show strong temporal agreement with observed trends.
- Mean differences are small and generally fall within 1–2 standard errors.
- No systematic over- or underestimation beyond error bounds.

### Block ribbon plots

```{r plot standardisation}
#| echo: false
#| warning: false
#| message: false


block_list <- c('16', '22', '23', '24', '27', '28')

# for (i in block_list) {
for (i in names(ts_pred_dat_list)) {  
 df_block <- ts_pred_dat_list[[i]]

  # Confirm needed columns exist
  if (!all(c("sampyear", "sublegal_n", "legal_n", "sublegal_pred", "legal_pred") %in% names(df_block))) next

  # === Step 1: Summarise by year ===
  summary_df <- df_block %>%
    group_by(sampyear) %>%
    summarise(
      mean_sublegal_obs = mean(sublegal_n, na.rm = TRUE),
      se_sublegal_obs = sd(sublegal_n, na.rm = TRUE) / sqrt(n()),
      mean_sublegal_pred = mean(sublegal_pred, na.rm = TRUE),
      se_sublegal_pred = sd(sublegal_pred, na.rm = TRUE) / sqrt(n()),
      mean_legal_obs = mean(legal_n, na.rm = TRUE),
      se_legal_obs = sd(legal_n, na.rm = TRUE) / sqrt(n()),
      mean_legal_pred = mean(legal_pred, na.rm = TRUE),
      se_legal_pred = sd(legal_pred, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )

  # === Step 2: Reshape to long format ===
plot_df <- summary_df %>%
  select(sampyear,
         mean_sublegal_obs, se_sublegal_obs,
         mean_sublegal_pred, se_sublegal_pred,
         mean_legal_obs, se_legal_obs,
         mean_legal_pred, se_legal_pred) %>%
  pivot_longer(
    cols = -sampyear,
    names_to = c("stat", "type"),
    names_pattern = "(mean|se)_(.*)"
  ) %>%
  pivot_wider(names_from = stat, values_from = value) %>%
  mutate(
    lower = mean - 1.96 * se,
    upper = mean + 1.96 * se,
    group = case_when(
      str_detect(type, "sublegal") ~ "Sublegal",
      str_detect(type, "legal") ~ "Legal"
    ),
    source = case_when(
      str_detect(type, "obs") ~ "Observed",
      str_detect(type, "pred") ~ "Predicted"
    )
  )

  # === Step 3: Plot ===
  p <- ggplot(plot_df, aes(x = sampyear, y = mean, group = type)) +
    theme_bw(base_size = 14) +
    geom_line(aes(colour = source, linetype = group), linewidth = 1.2) +
    geom_point(aes(colour = source, shape = group), size = 2.5) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = source), alpha = 0.2) +
    theme(
      legend.position = "top",
      legend.background = element_rect(fill = "white"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    ) +
    scale_colour_brewer(palette = "Set1") +
    scale_fill_brewer(palette = "Set1") +
    # scale_y_continuous(limits = c(0, 70)) +
    labs(
      title = paste("Observed vs Predicted Legal & Sublegal Counts:", i),
      x = "Year", y = "Mean count [abalone.10min-1]",
      colour = "Source", fill = "Source", linetype = "Size", shape = "Size"
    )

  print(p)
  
  # Optional save:
  # ggsave(paste0("abundance_plot_", i, ".png"), p, width = 9, height = 6)
}

```



### Block facet data

```{r facet plot data}

block_list <- c('16', '22', '23', '24', '27', '28')

# Initialise a list to store data
plot_df_all <- list()

# Loop through each block
for (i in block_list) {
  df_block <- ts_pred_dat_list[[i]]

  if (!all(c("sampyear", "sublegal_n", "legal_n", "sublegal_pred", "legal_pred") %in% names(df_block))) next

  summary_df <- df_block %>%
    group_by(sampyear) %>%
    summarise(
      mean_sublegal_obs = mean(sublegal_n, na.rm = TRUE),
      se_sublegal_obs = sd(sublegal_n, na.rm = TRUE) / sqrt(n()),
      mean_sublegal_pred = mean(sublegal_pred, na.rm = TRUE),
      se_sublegal_pred = sd(sublegal_pred, na.rm = TRUE) / sqrt(n()),
      mean_legal_obs = mean(legal_n, na.rm = TRUE),
      se_legal_obs = sd(legal_n, na.rm = TRUE) / sqrt(n()),
      mean_legal_pred = mean(legal_pred, na.rm = TRUE),
      se_legal_pred = sd(legal_pred, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )

  # Transform and tag block
  plot_df <- summary_df %>%
    select(sampyear,
           mean_sublegal_obs, se_sublegal_obs,
           mean_sublegal_pred, se_sublegal_pred,
           mean_legal_obs, se_legal_obs,
           mean_legal_pred, se_legal_pred) %>%
    pivot_longer(
      cols = -sampyear,
      names_to = c("stat", "type"),
      names_pattern = "(mean|se)_(.*)"
    ) %>%
    pivot_wider(names_from = stat, values_from = value) %>%
    mutate(
      lower = mean - 1.96 * se,
      upper = mean + 1.96 * se,
      group = case_when(
        str_detect(type, "sublegal") ~ "Sublegal",
        str_detect(type, "legal") ~ "Legal"
      ),
      source = case_when(
        str_detect(type, "obs") ~ "Observed",
        str_detect(type, "pred") ~ "Predicted"
      ),
      block = i
    )

  plot_df_all[[i]] <- plot_df
}

# Combine all blocks
combined_df <- bind_rows(plot_df_all)

# Create jitter for points, lines and errorbars
combined_df <- combined_df %>%
  mutate(
    sampyear_num = as.numeric(as.character(sampyear)),
    jitter_offset = case_when(
      group == "Legal" ~ -0.1,
      group == "Sub-legal" ~ 0.1,
      TRUE ~ 0
    ),
    sampyear_jittered = sampyear_num + jitter_offset
  )

```

### Sub-block facet data

```{r facet plot data}

block_list <- c('16', '22', '23', '24', '27', '28')

subblock_list <- c('16A', '16B', '16C', '16D',
                   '22A', '22B', '22C', '22D',
                   '23A', '23B', '23C', '23D',
                   '24A', '24B', '24C', '24D',
                   '27A', '27B', '27C', '27D',
                   '28A')

# Initialise a list to store data
plot_df_all <- list()

# Loop through each block
for (i in block_list) {
  df_block <- ts_pred_dat_list_subblock[[i]]

  if (!all(c("sampyear", "sublegal_n", "legal_n", "sublegal_pred", "legal_pred") %in% names(df_block))) next

  summary_df <- df_block %>%
    group_by(sampyear, subblockno) %>%
    summarise(
      mean_sublegal_obs = mean(sublegal_n, na.rm = TRUE),
      se_sublegal_obs = sd(sublegal_n, na.rm = TRUE) / sqrt(n()),
      mean_sublegal_pred = mean(sublegal_pred, na.rm = TRUE),
      se_sublegal_pred = sd(sublegal_pred, na.rm = TRUE) / sqrt(n()),
      mean_legal_obs = mean(legal_n, na.rm = TRUE),
      se_legal_obs = sd(legal_n, na.rm = TRUE) / sqrt(n()),
      mean_legal_pred = mean(legal_pred, na.rm = TRUE),
      se_legal_pred = sd(legal_pred, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )

  # Transform and tag block
  plot_df <- summary_df %>%
    select(sampyear, subblockno,
           mean_sublegal_obs, se_sublegal_obs,
           mean_sublegal_pred, se_sublegal_pred,
           mean_legal_obs, se_legal_obs,
           mean_legal_pred, se_legal_pred) %>%
    pivot_longer(
      cols = -c(sampyear, subblockno),
      names_to = c("stat", "type"),
      names_pattern = "(mean|se)_(.*)"
    ) %>%
    pivot_wider(names_from = stat, values_from = value) %>%
    mutate(
      lower = mean - 1.96 * se,
      upper = mean + 1.96 * se,
      group = case_when(
        str_detect(type, "sublegal") ~ "Sublegal",
        str_detect(type, "legal") ~ "Legal"
      ),
      source = case_when(
        str_detect(type, "obs") ~ "Observed",
        str_detect(type, "pred") ~ "Predicted"
      ),
      block = i
    )

  plot_df_all[[i]] <- plot_df
}

# Combine all blocks
combined_df_subblock <- bind_rows(plot_df_all)

# Create jitter for points, lines and errorbars
combined_df_subblock <- combined_df_subblock %>%
  mutate(
    sampyear_num = as.numeric(as.character(sampyear)),
    jitter_offset = case_when(
      group == "Legal" ~ -0.1,
      group == "Sub-legal" ~ 0.1,
      TRUE ~ 0
    ),
    sampyear_jittered = sampyear_num + jitter_offset
  )

```

#### Block ribbon plot

```{r facet plot error ribbon}

p <- ggplot(combined_df, aes(x = sampyear, y = mean, group = type)) +
  theme_bw(base_size = 14) +
  geom_line(aes(colour = source, linetype = group), linewidth = 1.2) +
  geom_point(aes(colour = source, shape = group), size = 2.5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = source), alpha = 0.2) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  scale_colour_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(limits = c(0, 80)) +
  labs(
    # title = "Observed vs Predicted Legal & Sublegal Counts by Block",
    x = "Year", y = "Mean count [abalone.10min-1]",
    colour = "Source", fill = "Source", linetype = "Size", shape = "Size"
  ) +
  facet_wrap(~ block)

print(p)

```

#### Block error bar plot

```{r facet plot jitter error}

p <- ggplot(combined_df, aes(x = sampyear_jittered, y = mean)) +
  theme_bw(base_size = 10) +

  geom_line(
    aes(colour = source, linetype = group, group = interaction(source, group)),
    linewidth = 0.8
  ) +

  geom_point(
    aes(colour = source, shape = group),
    size = 2.5
  ) +

  geom_errorbar(
    data = combined_df %>% filter(source == "Predicted"),
    aes(
      x = sampyear_jittered,
      ymin = lower,
      ymax = upper,
      colour = source,
      group = interaction(source, group)
    ),
    width = 0.3,
    linewidth = 0.8
  ) +

  facet_wrap(~ block) +
  scale_colour_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(limits = c(0, 80)) +
  labs(
    x = "Year",
    y = expression("Mean count [abalone.10min"^-1*"]"),
    colour = "Source", fill = "Source",
    linetype = "Size", shape = "Size"
  ) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

print(p)

```

#### Block standardised plot 

```{r predicted plot}

# Filter predicted data
predicted_df <- combined_df %>% filter(source == "Predicted")

predicted_df$group <- factor(predicted_df$group, levels = c("Legal", "Sublegal"))

# Define custom colors for legal and sub-legal
color_map <- c("Legal" = "blue", "Sublegal" = "red")

p <- ggplot(predicted_df, aes(x = sampyear_jittered, y = mean)) +
  theme_bw(base_size = 10) +

  geom_line(
    aes(colour = group, group = group),
    linewidth = 0.8
  ) +

  geom_point(
    aes(colour = group, group = group),
    size = 2.5
  ) +

  geom_errorbar(
    aes(
      x = sampyear_jittered,
      ymin = lower,
      ymax = upper,
      colour = group,
      group = group
    ),
    width = 0.3,
    linewidth = 0.8
  ) +

  facet_wrap(~ block) +
  scale_colour_manual(values = color_map) +
  # scale_fill_manual(values = color_map) +
  scale_y_continuous(limits = c(0, 70)) +
  labs(
    x = "Year",
    y = expression("Mean count [abalone.10min"^-1*"]"),
    colour = "Size", fill = "Size",
    linetype = "Size", shape = "Size"
  ) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

print(p)

ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_LegalSubLegal_MeanLinePlot', '.pdf', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)

ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_LegalSubLegal_MeanLinePlot', '.png', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)

```
#### Block relative change

```{r}
#| label: fig-abs-change-2020
#| fig-cap: "Asolute change in average abundance of all legal (>140 mm) and sub-legal (<140 mm) abalone counted within 10 minutes between paired divers at each site within each block and year to 2020 baselines and the hypothetical percentage changes."
#| echo: false
#| warning: false
#| message: false
#| fig-height: 7
#| fig-width: 7
#| out-height: 90%
#| fig-pos: "H"

# Filter predicted data
predicted_df <- combined_df %>% filter(source == "Predicted")

predicted_df$group <- factor(predicted_df$group, levels = c("Legal", "Sublegal"))

# Extract baseline abundance 2020 values
base_dat_2020 <- predicted_df %>% 
 filter(sampyear == 2020) %>% 
 dplyr::rename(mean_ab_n_2020 = 'mean') %>% 
 ungroup() %>%
 select(block, type, mean_ab_n_2020)

# Re-join baseline data to all data
dat_base_year <- left_join(predicted_df, base_dat_2020)

# Relative and absolute difference
dat_diff <- dat_base_year %>% 
 mutate(rel_diff = (mean - mean_ab_n_2020) / mean_ab_n_2020,
        abs_diff = mean - mean_ab_n_2020)


# Define custom colors for legal and sub-legal
color_map <- c("Legal" = "blue", "Sublegal" = "red")

p <- ggplot(dat_diff, aes(x = sampyear, y = abs_diff)) +
  theme_bw(base_size = 10) +

  geom_line(
    aes(colour = group, group = group),
    linewidth = 0.8
  ) +

  geom_point(
    aes(colour = group, group = group),
    size = 2.5
  ) +

  facet_wrap(~ block) +
  scale_colour_manual(values = color_map) +
  # scale_fill_manual(values = color_map) +
  labs(
    x = "Year",
    y = expression("Absolute change in abundance"),
    colour = "Size", fill = "Size",
    linetype = "Size", shape = "Size"
  ) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
 
  geom_hline(yintercept = 0, linetype = 'dotted', colour = 'red', size = 0.8)

print(p)




# #Absolute plot
# abs_change_plot <- dat_diff %>%
#  ggplot() +
#  geom_point(aes(x = sampyear, y = abs_diff, group = group, colour = group), size = 2.5, position = position_dodge(0.05)) +
#  geom_line(aes(x = sampyear, y = abs_diff, group = group, colour = group), size = 0.8) +
#  geom_hline(yintercept = 0, linetype = 'dotted', colour = 'red', size = 0.3) +
#  scale_colour_manual(values = c('blue', 'red'),
#                      labels = c('Legal', 'Sublegal'),
#                      name = 'Size') +
#  theme_bw() +
#  ylab(bquote('Absolute change in abundance')) +
#  xlab('Survey Year') +
#  theme(legend.position = 'bottom') +
#  # theme(legend.position = c(0.9, 0.3)
#  #       ,legend.background = element_rect(fill = NA, colour = NA))+
#  guides(colour = guide_legend(nrow =1)) +
#  # ylim(-30, 100)+
#  facet_wrap(. ~ block, ncol = 3)
# 
# abs_change_plot



ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_AbsoluteChangePlot', '.pdf', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)
ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_AbsoluteChangePlot', '.png', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)

```



# Summary Tables

## Sites surveyed

```{r site surveyed}
#| label: tbl-year-sites
#| tbl-cap: "Summary of number of sites surveyed in each block across years."
#| echo: false
#| warning: false
#| message: false
#| fig-pos: "H"


# Step 1: Create wide-format summary
df_site_summary <- ts_working_dat %>%
  filter(blockno %in% block_list) %>% 
  mutate(sampyear = as.character(sampyear)) %>%
  group_by(blockno, sampyear) %>%
  summarise(unique_sites = n_distinct(site), .groups = "drop") %>%
  pivot_wider(names_from = sampyear, values_from = unique_sites)

# Step 2: Sort year columns numerically
year_cols <- df_site_summary %>%
  select(-blockno) %>%
  names() %>%
  sort()

df_site_summary <- df_site_summary %>%
  select(blockno, all_of(year_cols))

# Step 3: Add totals row
totals_row <- df_site_summary %>%
  select(-blockno) %>%
  summarise(across(everything(), ~ sum(.x, na.rm = TRUE))) %>%
  mutate(blockno = "Total") %>%
  select(blockno, everything())

# Step 4: Bind totals row to summary
df_site_summary_with_total <- bind_rows(df_site_summary, totals_row)

df_site_summary_with_total_2025 <- bind_rows(df_site_summary, totals_row) %>% 
 select(blockno, '2025')

# Step 5: Create flextable table
flex_df_site_summary <- df_site_summary_with_total %>%
  dplyr::rename(Blockno = blockno) %>%
  flextable() %>%
  align(align = "center", part = "all") %>%
  autofit()

flex_df_site_summary_2025 <- df_site_summary_with_total_2025 %>%
  dplyr::rename(Blockno = blockno) %>%
  flextable() %>%
  align(align = "center", part = "all") %>%
  autofit()


flex_df_site_summary

flex_df_site_summary_2025

save_as_image(flex_df_site_summary_2025, path = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_SitesCompleted.png', sep = ''), sep = ''))

```
```{r}
#| label: fig-legal-count-sizeclass-lineplot
#| fig-cap: "Average count of each legal abalone size class within 10 minutes between paired divers at each site within each block by year."
#| echo: false
#| warning: false
#| message: false
#| fig-height: 7
#| fig-width: 7
#| out-height: 90%
#| fig-pos: "H"

# Arrange size classes in order
sizeclasses <- c("0-100", "100-120", "120-140", "140-160", "160-180", "180-200", "200-220")

# Colour palette


cbp2 <- c("#D55E00", "#000000", "#009E73", "#0072B2", "#999999", "#CC79A7", "#E69F00")

cbp2 <- c('#FF0000', '#FFA07A', '#F08080','#0000FF', '#4169E1', '#00BFFF', '#ADD8E6')


# Determine mean abalone abundance in each block, year and size class
ten_min_mean_year <- time_swim_dat_final %>% 
 mutate(sizeclass_2021 = factor(sizeclass_2021, levels = sizeclasses)) %>% 
 filter((!subblockno %in% c('28B', '28C') & 
         !blockno %in% c('13', '14', '21', '29', '30') &
         !is.na(sizeclass_freq_10) &
         sampyear <= samp_year)) %>% 
 group_by(blockno, site, diver, sampyear, time_elapsed, sizeclass_2021, legal_size) %>% 
 summarise(ab_n = sum(sizeclass_freq_10)) %>% 
 group_by(blockno, sampyear, sizeclass_2021, legal_size) %>% 
 summarise(mean_ab_n = mean(ab_n),
           median_ab_n = median(ab_n),
           std_err = sd(ab_n)/sqrt(n())) 

abundance_plot_legal <- ten_min_mean_year %>% 
 filter(blockno != 13 & legal_size == '>140 mm') %>% 
 ggplot(aes(x = sampyear, y = mean_ab_n, group = sizeclass_2021, colour = sizeclass_2021))+
 # geom_point(position = position_dodge(0.05))+
 # geom_line(position = position_dodge(0.05))+
 # geom_errorbar(aes(ymin = mean_ab_n -  std_err, ymax = mean_ab_n + std_err), width = 0.2,
 #               position = position_dodge(0.05))+
 geom_point(position = position_jitter(width = 0.05, seed = 1))+
 geom_line(position = position_jitter(width = 0.05, seed = 1))+
 geom_errorbar(aes(ymin = mean_ab_n -  std_err, ymax = mean_ab_n + std_err), width = 0.2,
               position = position_jitter(width = 0.05, seed = 1))+
 # scale_colour_manual(values = cbp2)+
 theme_bw()+
 ylab(bquote('Average count (abalone.10'*~min^-1*')'))+
 xlab('Survey Year')+
 ylim(-1, 45)+
 theme(legend.position = 'bottom',
       legend.background = element_rect(fill = "white", colour = NA))+
 guides(colour = guide_legend(title = "Size Class"))+
 facet_wrap(. ~ blockno, ncol = 3)

abundance_plot_legal

ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_SizeClasses_MeanLinePlot_Legal', '.pdf', sep = ''), sep = ''), plot = abundance_plot_legal, units = 'mm', width = 190, height = 200)
ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_SizeClasses_MeanLinePlot_Legal', '.png', sep = ''), sep = ''), plot = abundance_plot_legal, units = 'mm', width = 190, height = 200)
```

```{r}
#| label: fig-sublegal-count-sizeclass-lineplot
#| fig-cap: "Average count of each sub-legal abalone size class within 10 minutes between paired divers at each site within each block by year."
#| echo: false
#| warning: false
#| message: false
#| fig-height: 7
#| fig-width: 7
#| out-height: 90%
#| fig-pos: "H"

# Arrange size classes in order
sizeclasses <- c("0-100", "100-120", "120-140", "140-160", "160-180", "180-200", "200-220")

# Colour palette


cbp2 <- c("#D55E00", "#000000", "#009E73", "#0072B2", "#999999", "#CC79A7", "#E69F00")

cbp2 <- c('#FF0000', '#FFA07A', '#F08080','#0000FF', '#4169E1', '#00BFFF', '#ADD8E6')


# Determine mean abalone abundance in each block, year and size class
ten_min_mean_year <- time_swim_dat_final %>% 
 mutate(sizeclass_2021 = factor(sizeclass_2021, levels = sizeclasses)) %>% 
 filter((!subblockno %in% c('28B', '28C') & 
         !blockno %in% c('13', '14', '21', '29', '30') &
         !is.na(sizeclass_freq_10) &
         sampyear <= samp_year)) %>% 
 group_by(blockno, site, diver, sampyear, time_elapsed, sizeclass_2021, legal_size) %>% 
 summarise(ab_n = sum(sizeclass_freq_10)) %>% 
 group_by(blockno, sampyear, sizeclass_2021, legal_size) %>% 
 summarise(mean_ab_n = mean(ab_n),
           median_ab_n = median(ab_n),
           std_err = sd(ab_n)/sqrt(n())) 

abundance_plot_sub <- ten_min_mean_year %>% 
 filter(blockno != 13 & legal_size == '<140 mm') %>% 
 ggplot(aes(x = sampyear, y = mean_ab_n, group = sizeclass_2021, colour = sizeclass_2021))+
 # geom_point(position = position_dodge(0.05))+
 # geom_line(position = position_dodge(0.05))+
 # geom_errorbar(aes(ymin = mean_ab_n -  std_err, ymax = mean_ab_n + std_err), width = 0.2,
 #               position = position_dodge(0.05))+
 geom_point(position = position_jitter(width = 0.05, seed = 1))+
 geom_line(position = position_jitter(width = 0.05, seed = 1))+
 geom_errorbar(aes(ymin = mean_ab_n -  std_err, ymax = mean_ab_n + std_err), width = 0.2,
               position = position_jitter(width = 0.05, seed = 1))+
 # scale_colour_manual(values = cbp2)+
 theme_bw()+
 ylab(bquote('Average count (abalone.10'*~min^-1*')'))+
 xlab('Survey Year')+
 ylim(-1, 35)+
 theme(legend.position = 'bottom',
       legend.background = element_rect(fill = "white", colour = NA))+
 guides(colour = guide_legend(title = "Size Class"))+
 facet_wrap(. ~ blockno, ncol = 3)

abundance_plot_sub

ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_SizeClasses_MeanLinePlot_Sub-Legal', '.pdf', sep = ''), sep = ''), plot = abundance_plot_sub, units = 'mm', width = 190, height = 200)
ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_TenMinuteCount_SizeClasses_MeanLinePlot_Sub-Legal', '.png', sep = ''), sep = ''), plot = abundance_plot_sub, units = 'mm', width = 190, height = 200)
```




# Block 16 - standardised

```{r relative abundance subblock plot}
#| label: fig-abs-change-2020-subblock
#| fig-cap: "Asolute change in average abundance of all legal (>140 mm) and sub-legal (<140 mm) abalone counted within 10 minutes between paired divers at each site within Block 16 sub-blocks by year to 2020 baselines (red dotted lines). Coloured dashed lines are hypothetical percentage change in abundance between consecutive years for each sub-block."
#| echo: false
#| warning: false
#| message: false
#| fig-height: 6.5
#| fig-width: 6
#| out-height: 90%
#| fig-pos: "H"

# Filter predicted data
predicted_df <- combined_df_subblock %>% 
 filter(source == "Predicted" &
         block == '16')

predicted_df$group <- factor(predicted_df$group, levels = c("Legal", "Sublegal"))

# Extract baseline abundance 2020 values
base_dat_2020 <- predicted_df %>% 
 filter(sampyear == 2020) %>% 
 dplyr::rename(mean_ab_n_2020 = 'mean') %>% 
 ungroup() %>%
 select(subblockno, type, mean_ab_n_2020)

# Re-join baseline data to all data
dat_base_year <- left_join(predicted_df, base_dat_2020)

# Relative and absolute difference
dat_diff_subblock <- dat_base_year %>% 
 mutate(rel_diff = (mean - mean_ab_n_2020) / mean_ab_n_2020,
        abs_diff = mean - mean_ab_n_2020)

#Absolute plot

# Define custom colors for legal and sub-legal
color_map <- c("Legal" = "blue", "Sublegal" = "red")

p <- ggplot(dat_diff_subblock, aes(x = sampyear, y = abs_diff)) +
  theme_bw(base_size = 10) +

  geom_line(
    aes(colour = group, group = group),
    linewidth = 0.8
  ) +

  geom_point(
    aes(colour = group, group = group),
    size = 2.5
  ) +

  facet_wrap(~ subblockno) +
  scale_colour_manual(values = color_map) +
  # scale_fill_manual(values = color_map) +
  labs(
    x = "Year",
    y = expression("Absolute change in abundance"),
    colour = "Size", fill = "Size",
    linetype = "Size", shape = "Size"
  ) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
 
  geom_hline(yintercept = 0, linetype = 'dotted', colour = 'red', size = 0.8)+
 ylim(-10, 30)

print(p)

ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_Block_16_TenMinuteCount_SubBlock_AbsoluteChangePlot', '.pdf', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)
ggsave(filename = paste(ts_plots_folder, paste('/TimedSwimSurvey_', samp_year, '_Block_16_TenMinuteCount_SubBlock_AbsoluteChangePlot', '.png', sep = ''), sep = ''), plot = p, units = 'mm', width = 190, height = 200)

```

# Dive Depth Planning

An examination of historical site survey data to determine approximate depths of survey sites in sample year for dive planning.

```{r dive planning}

GDA2020 <- st_crs(7855)
WGS84 <- st_crs(4326)

# Create data frame of historical survey sites and depths, removing erroneous or missing depth data
his_depth_dat <- time_swim_meta_dat_final %>% 
 select(site, starttime, blockno, max.depth, start_geom, ref_site) %>% 
 dplyr::rename(max_depth = 'max.depth',
               geom = 'start_geom') %>% 
 filter(max_depth > 1) %>% 
 mutate(samp_year = year(starttime)) %>% 
 st_as_sf(crs = GDA2020)

# Load proposed sites for survey year
prop_sites <- st_read(paste(samp_year_folder, '/TimedSwimSites_EastCoast_Final_2025.gpkg', sep = ''))


# Transform to same datum
prop_sites <- prop_sites %>% 
 st_transform(., GDA2020) %>% 
 select(-c(subblockno, oid, cell_ntile, cell.ntile, sam_count))

# Get index of nearest historical site for each proposed site
nearest_site_idx <- st_nearest_feature(prop_sites, his_depth_dat)

# Extract nearest features
nearest_site_features <- his_depth_dat[nearest_site_idx, ] %>% 
 select(geom, max_depth) %>% 
 mutate(max_depth = ceiling(max_depth))

# Calculate distance to nearest feature
nearest_site_distances <- st_distance(prop_sites, nearest_site_features, by_element = TRUE)

# Combine: join attributes and add distance
joined_site_dat <- prop_sites %>%
  bind_cols(st_drop_geometry(nearest_site_features)) %>%
  mutate(distance_m = round(as.numeric(nearest_site_distances), 0))

# Create depth intervals according to bounce diving guideline (Smart et al. 2014)
bounce_depth_site_dat <- joined_site_dat %>% 
  mutate(depth_cat = case_when(
    max_depth <= 12 ~ "<12",
    max_depth >= 13 & max_depth <= 15 ~ "13–15",
    max_depth >= 16 & max_depth <= 18 ~ "16–18",
    max_depth >= 19 & max_depth <= 21 ~ "19–21",
    max_depth > 21 ~ ">21",
    TRUE ~ "Unclassified"
  )) %>% 
 mutate(depth_cat = factor(depth_cat, levels = c("<12", "13–15", "16–18", "19–21", ">21", "Unclassified"), ordered = TRUE))

# Create summary of sites and depths by block

block_depth_summary <- bounce_depth_site_dat %>% 
 st_drop_geometry() %>% 
 group_by(blockno, depth_cat) %>% 
 summarise(sites = n_distinct(site))

block_summary_wide <- block_depth_summary %>% 
 pivot_wider(id_cols = blockno, names_from = 'depth_cat', values_from = 'sites')

# Table of remaining sites and depths

sites_completed <- his_depth_dat %>% 
 filter(samp_year == '2025') %>% 
 select(site) %>% 
 st_drop_geometry() %>% 
 mutate(site_complete = 1)

sites_remaining <- bounce_depth_site_dat %>% 
 # st_drop_geometry() %>% 
 left_join(., sites_completed, by = c('site')) %>% 
 filter(is.na(site_complete)) %>% 
 select(-site_complete)

sites_remaining_df <- sites_remaining %>% 
  st_transform(crs = st_crs(WGS84)) %>%
  sfheaders::sf_to_df(fill = T) %>%
  dplyr::rename('latitude' = y,
                'longitude' = x)

sites_remaining_summary <- sites_remaining_df %>% 
 group_by(blockno, depth_cat) %>% 
 summarise(sites = n_distinct(site)) %>% 
 pivot_wider(id_cols = blockno, names_from = 'depth_cat', values_from = 'sites')



# For KML file

# Create KML document


kml <- newXMLDoc()
root <- newXMLNode("kml", namespaceDefinitions = c(kml = "http://www.opengis.net/kml/2.2"), doc = kml)
doc <- newXMLNode("Document", parent = root)

# Define styles for each category
styles <- list(
  "<12"         = list(icon = "http://maps.google.com/mapfiles/kml/paddle/grn-circle.png"),
  "13–15"       = list(icon = "http://maps.google.com/mapfiles/kml/paddle/orange-circle.png"),
  "16–18"       = list(icon = "http://maps.google.com/mapfiles/kml/paddle/purple-circle.png"),
  "19–21"       = list(icon = "http://maps.google.com/mapfiles/kml/paddle/ltblu-circle.png"),
  ">21"         = list(icon = "http://maps.google.com/mapfiles/kml/paddle/red-circle.png"),
  "Unclassified"= list(icon = "http://maps.google.com/mapfiles/kml/paddle/wht-circle.png")
)


# Add style definitions
for (cat in names(styles)) {
  style <- newXMLNode("Style", attrs = c(id = cat), parent = doc)
  iconStyle <- newXMLNode("IconStyle", parent = style)
  icon <- newXMLNode("Icon", parent = iconStyle)
  newXMLNode("href", styles[[cat]]$icon, parent = icon)
}

sites_remaining_kml <- sites_remaining %>% 
 st_transform(crs = WGS84)

# Add placemarks
for (i in seq_len(nrow(sites_remaining_kml))) {
  pt <- st_coordinates(sites_remaining_kml[i, ])
  cat <- sites_remaining$depth_cat[i]
  pm <- newXMLNode("Placemark", parent = doc)
  newXMLNode("name", sites_remaining_kml$site[i], parent = pm)
  newXMLNode("styleUrl", paste0("#", cat), parent = pm)
  point <- newXMLNode("Point", parent = pm)
  newXMLNode("coordinates", paste(pt[1], pt[2], sep = ","), parent = point)
}


# Save files

gis_folder_path <- paste(file.path(paste(sprintf('C:/Users/%s/Dropbox (UTAS Research)/DiveFisheries/GIS/SpatialLayers/TimeSwimLayers',
Sys.info()[["user"]]), sep = '')))

outname_point <- paste(gis_folder_path, paste('/TimedSwimSites_EastCoast_Sept_Oct_2025_Depth.gpkg', sep = ""), sep = '')

st_write(sites_remaining, dsn = outname_point, layer = "pointqt", driver = "GPKG", append = F)

outname_point_kml <- paste(gis_folder_path, paste('/TimedSwimSites_EastCoast_Sept_Oct_2025_Depth.kml', sep = ""), sep = '')

saveXML(kml, file = paste(gis_folder_path, '/TimedSwimSites_EastCoast_Sept_Oct_2025_Depth_Categorised.kml', sep = "")) 

# saveXML(kml, dsn = outname_point_kml_2, layer = "pointqt", driver = "kml", append = F)

write.xlsx(sites_remaining_df, paste(gis_folder_path, paste('/TimedSwimSites_EastCoast_Sept_Oct_2025_Depth.xlsx', sep = ""), sep = ''), sheetName = "Sheet1", colNames = TRUE, rowNames = TRUE, append = FALSE)

```